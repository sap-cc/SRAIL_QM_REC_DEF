{"version":3,"sources":["../../src/controller/Main.controller.ts"],"names":["value","direct","then","Promise","resolve","body","recover","result","e","f","args","i","arguments","length","apply","reject","BaseController","MainController","onInit","oViewModel","JSONModel","defectCategory","loading","error","getView","setModel","oRouter","getRoute","attachPatternMatched","onRouteMatched","onExit","detachPatternMatched","oEvent","oRouteParameters","getParameter","setData","refresh","oODataModel","metadataLoaded","getMetaModel","loaded","oError","errorMessage","parseError","oEntityType","getODataEntityType","aSupportedProperties","property","map","oProperty","name","type","oPredefinedValuesFromRoute","getRouteParameters","oPredefinedValuesFromStartup","getStartupParameters","oPredefinedValuesMerged","ZZ1_NC_LAYOUT_VARIANT_NIT","DefectCategory","read","success","oDraftController","createNewDraftEntity","oEntryContext","context","navigateToDefectRecord","getPath","aFieldsToExtract","reduce","oParameterMap","sKey","convertParameter"],"mappings":"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","sourcesContent":["import Event from \"sap/ui/base/Event\";\nimport Context from \"sap/ui/model/Context\";\nimport JSONModel from \"sap/ui/model/json/JSONModel\";\nimport BaseController from \"zqm/nc/recdefectfast/controller/Base.controller\";\nimport { RequestError } from \"zqm/nc/recdefectfast/types/error\";\nimport { ODataPropertyMetadataDefinition } from \"zqm/nc/recdefectfast/util/ODataHelper\";\n\n/**\n * @namespace zqm.nc.recdefectfast.controller\n */\nexport default class MainController extends BaseController {\n\n    private oViewModel: JSONModel;\n\n    onInit() {\n        super.onInit();\n        this.oViewModel = new JSONModel({\n            defectCategory: null,\n            loading: true,\n            error: null,\n        });\n        this.getView().setModel(this.oViewModel);\n        // eslint-disable-next-line @typescript-eslint/unbound-method\n        this.oRouter.getRoute(\"main\").attachPatternMatched(this.onRouteMatched, this);\n    }\n\n    onExit() {\n        // eslint-disable-next-line @typescript-eslint/unbound-method\n        this.oRouter.getRoute(\"main\").detachPatternMatched(this.onRouteMatched, this);\n    }\n\n    private async onRouteMatched(oEvent: Event) {\n        // Note: need to read route parameters at first, later it becomes null\n        const oRouteParameters = oEvent.getParameter(\"arguments\") as { \"?query\"?: Record<string, string> };\n\n        this.oViewModel.setData({\n            defectCategory: null,\n            loading: true,\n            error: null,\n        });\n        this.oViewModel.refresh();\n\n        try {\n            await this.oODataModel.metadataLoaded(true);\n            await this.oODataModel.getMetaModel().loaded();\n        } catch (oError: RequestError | Error | unknown) {\n            const errorMessage = this.parseError(oError);\n            this.oViewModel.setData({\n                loading: false,\n                error: errorMessage,\n            }, true);\n            return;\n        }\n\n        // determine supported property names for predinfed values\n        const oEntityType = this.oODataModel.getMetaModel().getODataEntityType(\"QM_DEFECT_RECORD_SRV.C_DefectRecordType\") as { property: Array<ODataPropertyMetadataDefinition> };\n        const aSupportedProperties: Array<{ name: string, type: string }> = oEntityType.property.map((oProperty) => ({\n            name: oProperty.name,\n            type: oProperty.type\n        }));\n\n        // get the predefined values\n        const oPredefinedValuesFromRoute = this.getRouteParameters(oRouteParameters[\"?query\"] ?? {}, aSupportedProperties);\n        const oPredefinedValuesFromStartup = this.getStartupParameters(aSupportedProperties);\n        const oPredefinedValuesMerged: Record<string, string | boolean> = {\n            ZZ1_NC_LAYOUT_VARIANT_NIT: \"STANDARD\",\n            ...oPredefinedValuesFromStartup,\n            ...oPredefinedValuesFromRoute\n        };\n\n        if (!oPredefinedValuesMerged.DefectCategory) {\n            this.oViewModel.setData({\n                loading: false,\n                error: \"Defect category is missing\",\n            }, true);\n            return;\n        }\n\n        this.oODataModel.read(`/C_DefectCatVH('${oPredefinedValuesMerged.DefectCategory as string}')`, {\n            success: async () => {\n                // create draft & redirect to form page\n                try {\n                    const { context: oEntryContext } = await this.oDraftController.createNewDraftEntity(\"C_DefectRecord\", \"/C_DefectRecord\", oPredefinedValuesMerged) as { context: Context, data: object, response: object };\n                    this.navigateToDefectRecord(oEntryContext.getPath(), true);\n                } catch (oError: Error | RequestError | unknown) {\n                    const errorMessage = this.parseError(oError);\n                    this.oViewModel.setData({\n                        loading: false,\n                        error: errorMessage,\n                    }, true);\n                }\n            },\n            error: (oError: RequestError) => {\n                const errorMessage = this.parseError(oError);\n                this.oViewModel.setData({\n                    loading: false,\n                    error: errorMessage,\n                }, true);\n            }\n        })\n    }\n\n    private getRouteParameters(oRouteParameters: Record<string, string>, aFieldsToExtract: Array<{ name: string, type: string }>): Record<string, string | boolean> {\n        return aFieldsToExtract\n            .reduce<Record<string, string | boolean>>((oParameterMap, { name: sKey, type }) => {\n                if (oRouteParameters[sKey] != null) {\n                    // prefer url parameters\n                    oParameterMap[sKey] = this.convertParameter(oRouteParameters[sKey], type);\n                }\n                return oParameterMap;\n            }, {});\n    }\n}\n"],"file":"Main.controller.js"}