"use strict";sap.ui.define(["sap/m/Button","sap/m/CheckBox","sap/m/Dialog","sap/m/Label","sap/m/library","sap/ui/core/HTML","sap/m/VBox","sap/m/MessageBox","sap/m/MessageToast","sap/m/UploadCollectionParameter","sap/ui/comp/smartfield/SmartField","sap/ui/core/Core","sap/ui/core/format/DateFormat","sap/ui/core/format/FileSizeFormat","sap/ui/core/Fragment","sap/ui/core/message/ControlMessageProcessor","sap/ui/layout/VerticalLayout","sap/ui/model/ChangeReason","sap/ui/model/json/JSONModel","zqm/nc/recdefectfast/controller/Base.controller","zqm/nc/recdefectfast/util/ODataHelper","zqm/nc/recdefectfast/util/Validator","zqm/nc/recdefectfast/util/ValueHelp","zqm/nc/recdefectfast/util/types","zqm/nc/recdefectfast/util/debounce","sap/base/util/array/uniqueSort"],function(e,t,r,a,n,o,i,s,c,u,l,d,f,g,m,p,h,v,y,_,D,C,P,w,O,M){function A(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function b(){}function I(e,t){if(!t){return e&&e.then?e.then(b):Promise.resolve()}}function x(e,t,r){if(r){return t?t(e):e}if(!e||!e.then){e=Promise.resolve(e)}return t?e.then(t):e}function B(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}function T(e){if(e&&e.then){return e.then(b)}}function V(e,t){if(e)throw t;return t}function E(e,t){try{var r=e()}catch(e){return t(true,e)}if(r&&r.then){return r.then(t.bind(null,false),t.bind(null,true))}return t(false,r)}function S(e){return function(){for(var t=[],r=0;r<arguments.length;r++){t[r]=arguments[r]}try{return Promise.resolve(e.apply(this,t))}catch(e){return Promise.reject(e)}}}function F(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,a)}return r}function j(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?F(Object(r),!0).forEach(function(t){N(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):F(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function N(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}var R=n["ButtonType"];var k=n["DialogType"];var U=n["FlexAlignItems"];var L=s["Action"];var z=A(_);var q=D["getAffectedPropertiesByChangedProperties"];var H=D["getAllODataNavigationPropertiesForSapText"];var Z=D["getEntitySetNameByBindingContextPath"];var K=A(C);var G=A(P);var Y=w["isInstanceOf"];var W=O["debounce"];var J;(function(e){e["VALIDATION"]="validation";e["TEMPLATE"]="template"})(J||(J={}));var Q="00000000-0000-0000-0000-000000000000";var $=z.extend("zqm.nc.recdefectfast.controller.RecordController",{onInit:function e(){z.prototype.onInit.call(this);this.validator=new K(this.getView());this.getView().setModel(this.oODataModel);this.getView().setModel(this.oODataModel,"vh");this.oAttachmentODataModel=this.oOwnerComponent.getModel("odata-attachment");this.oAttachmentModel=new y({items:[]});this.getView().setModel(this.oAttachmentModel,"__attachmentData");var t=new p;this.messageManager=sap.ui.getCore().getMessageManager();this.messageManager.registerMessageProcessor(t);this.getView().setModel(this.messageManager.getMessageModel(),"message");this.messageManager.registerObject(this.getView(),true);this.oRouter.getRoute("record").attachPatternMatched(this.onRouteMatched,this);this.oODataModel.attachPropertyChange(this.handleModelPropertyChange,this);this.submitChanges=W(this.submitChanges.bind(this),200)},onExit:function e(){this.oODataModel.detachPropertyChange(this.handleModelPropertyChange,this)},handleModelPropertyChange:function e(t){try{var r=this;var a=r.oDraftController.getDraftContext();var n=t.getParameter("context");if(!a.hasDraft(n)){return x()}var o=r.oODataModel.getMetaModel();if(!o.getODataEntitySet(Z(n.getPath()))){return x()}return x(I(r.submitChanges()))}catch(e){return Promise.reject(e)}},submitChanges:function e(){try{var t=this;var r=t.oODataModel.getPendingChanges();var a=t.getView().getBindingContext();var n=a.getPath().replace(/^\/+/,"");var o=r[n]||{};var i=Object.keys(o).filter(function(e){return e!=="__metadata"});var s=q(t.oODataModel.getMetaModel(),"C_DefectRecord",i);var c=t.getView().getControlsByFieldGroupId("").filter(function(e){return Y(e,l)}).filter(function(e){var t=e.getDataProperty();return t!=null&&t.property!=null&&s.indexOf(t.property.name)!==-1});return x(t.oDraftController.triggerSubmitChanges({noShowSuccessToast:false,noShowResponse:true,noBlockUI:true,failedMsg:"",successMsg:""}),function(){c.forEach(function(e){if(e._oFactory&&e._oFactory.reBind){e._oFactory.reBind()}})})}catch(e){return Promise.reject(e)}},valueListChanged:function e(t){var r=t.getSource();var a=this.getView().getBindingContext();var n=a.getModel();var o=t.getParameters().changes;var i=r.getDataProperty().property.name;var s=r.getValue();var c=j(N({},i,s),o);Object.keys(c).map(function(e){var t=a.getPath(e);var r=c[e];return{sProperty:e,sPropertyPath:t,sValue:r}}).forEach(function(e){n.setProperty(e.sPropertyPath,e.sValue);n.firePropertyChange({reason:v.Change,path:e.sProperty,value:e.sValue,context:a})})},onEdit:function e(){try{var t=this;return x(T(B(function(){return x(t.oDraftController.createEditDraftEntity(t.getView().getBindingContext(),true),function(e){var r=e,a=r.context;t.navigateToDefectRecord(a.getPath())})},function(e){var r=t.parseError(e.response!=null?e.response:e);s.error(r,{title:t.translate("common_text_error")})})))}catch(e){return Promise.reject(e)}},onSave:function e(){try{var t=this;t.messageManager.removeAllMessages();return x(t.validator.validateFieldGroup(J.VALIDATION),function(e){if(e){t.validator.focusFirstError(J.VALIDATION);return}return x(t.requestUserConfirmation(),function(e){if(!e){return}var r=t.getView().getBindingContext();var a=!r.getProperty("HasActiveEntity");t.getView().setBusy(true);return T(B(function(){return x(t.oDraftController.triggerSubmitChanges({noShowSuccessToast:false,noShowResponse:true,noBlockUI:true,failedMsg:"",successMsg:""}),function(){return x(t.oOwnerComponent.getDraftController().prepareDraftEntity(r),function(){return x(t.oOwnerComponent.getDraftController().activateDraftEntity(r,"to_DefectLongTextTP"),function(e){var r=e,n=r.context;t.getView().setBusy(false);t.navigateToDefectRecord(n.getPath());c.show(t.translate(a?"defect_status_create_success":"defect_status_update_success"))})})})},function(e){t.getView().setBusy(false);var r=t.parseError(e);s.error(r,{title:t.translate("defect_status_save_error")})}))})})}catch(e){return Promise.reject(e)}},onDiscardDraft:function e(){var t=this;var r=this.getView().getBindingContext();var a=r.getProperty("HasActiveEntity");var n=r.getProperty("DefectInternalID");s.warning(a?this.translate("defect_discard_defect_changes_text"):this.translate("defect_discard_defect_draft_text"),{title:a?this.translate("defect_discard_defect_changes_title"):this.translate("defect_discard_defect_draft_title"),actions:[L.OK,L.CANCEL],emphasizedAction:L.OK,onClose:function e(o){if(o===L.OK){t.oODataModel.remove(r.getPath(),{success:function e(){if(a){var r=t.oODataModel.createKey("/C_DefectRecord",{DefectInternalID:n,DraftUUID:Q,IsActiveEntity:true});t.navigateToDefectRecord(r,true)}else{t.navigateBack()}},error:function e(r){var a=t.parseError(r);s.error(a,{title:t.translate("defect_discard_status_error")})}})}}})},onCreateDefect:function n(){var o=this;var i=this.getView().getBindingContext();var s=new r({type:k.Message,title:this.translate("defect_create_new_dialog_title"),content:[new h({content:[new a({text:this.translate("defect_create_new_dialog_text")}),new t("createDefectWithTemplate",{text:this.translate("defect_create_new_dialog_current_as_template"),selected:true})]})],beginButton:new e({type:R.Emphasized,text:this.translate("common_action_create"),press:function e(){var t=d.byId("createDefectWithTemplate").getSelected();s.setBusy(true);var r=i.getProperty("DefectCategory");var a=i.getProperty("ZZ1_NC_LAYOUT_VARIANT_NIT");var n=j(j({},t?o.getTemplateValues():{}),{},{ZZ1_NC_LAYOUT_VARIANT_NIT:a,DefectCategory:r});o.navigateToCreateDefect(n,false);s.close();s.destroy()}}),endButton:new e({text:this.translate("common_action_cancel"),press:function e(){s.close();s.destroy()}})});s.open()},onPrintBlockingCard:function t(){var n=this;var o=this.oOwnerComponent.getModel("odata-manage-defect");var i=this.getView().getBindingContext();var u=i.getProperty("DefectInternalID");var l=new r({type:k.Message,title:this.translate("blocking_card_print_dialog_title"),content:[new h({content:[new a({text:this.translate("blocking_card_print_dialog_text")})]})],beginButton:new e({type:R.Emphasized,text:this.translate("common_action_print"),press:function e(){l.setBusy(true);o.callFunction("/C_DefectMng_Print_Blocking_Card",{method:"POST",urlParameters:{DefectInternalId:u},success:function e(){l.setBusy(false);l.close();l.destroy();c.show(n.translate("blocking_card_print_status_success"))},error:function e(t){var r=n.parseError(t);l.setBusy(false);s.error(r,{title:n.translate("blocking_card_print_status_error")})}})}}),endButton:new e({text:this.translate("common_action_cancel"),press:function e(){l.close();l.destroy()}})});l.open()},onMessagePopoverPress:function e(t){try{var r=this;var a=t.getSource();return x(r.getMessagePopover(),function(e){e.openBy(a)})}catch(e){return Promise.reject(e)}},isValueEqual:function e(t,r){return t===r},onSelectRadioButton:function e(t,r){var a=t.getParameter("selectedIndex");var n=t.getSource();var o=n.getButtons()[a];var i=o.data("value");var s=n.getBindingContext().getPath(r);var c=n.getBindingContext().getModel();c.setProperty(s,i);c.firePropertyChange({reason:v.Change,path:r,value:i,context:n.getBindingContext()});n.setValueState(undefined)},onSelectCheckbox:function e(t){var r=this;var a=t.getSource();var n=a.data("validationname");if(!n){return}var o=this.getView().getControlsByFieldGroupId(n).filter(function(e){return e.isA(["sap.m.CheckBox"])});o.forEach(function(e){r.validator.validateFieldCheckbox(e)})},onValueHelpRequested:function e(t,r){try{var a=this;return x(I(G.showValueHelp(a.getView().getBindingContext(),r)))}catch(e){return Promise.reject(e)}},onElementHiddenResetValue:function e(t){var r=t.getSource();if(!r.getVisible()){var a=r.getBinding("value");a.setValue("")}},onRouteMatched:function e(t){try{var r=this;var a=t.getParameter("arguments");var n="/"+a.defectRecordPath;r.getView().setBusy(true);return x(r.oODataModel.metadataLoaded(),function(){var e=H(r.oODataModel.getMetaModel(),"C_DefectRecord");var t=e.filter(function(e){return e.startsWith("to_ZZ1")});var a=["to_Product","to_DefectCode","to_DefectCodeGroup","to_DefectLongTextTP","to_ProductionOrderStdVH","to_ProdnOrdOpBySemKeyStdVH","to_StorageLocation"];var o=[].concat(t,a).sort();r.oODataModel.read(n,{urlParameters:{$expand:o.join(",")},success:S(function(){r.getView().bindElement({path:n,parameters:{expand:o.join(",")}});var e=r.oODataModel.getProperty(n+"/DefectCategory");var t=r.oODataModel.getProperty(n+"/ZZ1_NC_LAYOUT_VARIANT_NIT");if(!t){t="STANDARD";r.oODataModel.setProperty(n+"/ZZ1_NC_LAYOUT_VARIANT_NIT",t)}return T(E(function(){return B(function(){return I(Promise.all([r.initDefectCategory(e,t),r._readAttachments()]))},function(e){var t=r.parseError(e);s.error(t,{title:r.translate("common_text_error")})})},function(e,t){r.getView().setBusy(false);return V(e,t)}))}),error:function e(t){var a=r.parseError(t);s.error(a,{title:r.translate("common_text_error")})}})})}catch(e){return Promise.reject(e)}},onBeforeStartAttachmentUpload:function e(t){var r=this.getView().getBindingContext();var a=r.getProperty("DefectInternalID");var n=t.getParameter("fileName");var o=t.getParameter("addHeaderParameter");o(new u({name:"objectKey",value:btoa(encodeURIComponent(a))}));o(new u({name:"objectType",value:"QFGEN"}));o(new u({name:"documentType",value:"A03"}));o(new u({name:"documentNumber",value:""}));o(new u({name:"documentVersion",value:""}));o(new u({name:"documentPart",value:""}));o(new u({name:"semanticobjecttype",value:""}));o(new u({name:"Accept",value:"application/json"}));o(new u({name:"slug",value:btoa(encodeURIComponent(n))}));o(new u({name:"x-csrf-token",value:this.oAttachmentODataModel.getSecurityToken()}))},onCompletedAttachmentUpload:function e(t){var r=this;var a=this.oAttachmentModel.getData();var n=t.getParameter("files");n.forEach(function(e){try{if(e.status===200||e.status===201){var t=JSON.parse(e.responseRaw);a.items.unshift(r._mapOriginalContentToAttachmentItem(t.d))}else if(e.responseRaw){throw new Error(r.parseError({responseText:e.responseRaw}))}else{throw new Error}}catch(e){var n=r.parseError(e);s.error(n,{title:r.translate("defect_attachment_upload_error")})}});this.oAttachmentModel.setData(a,false);this.oAttachmentModel.refresh(true)},onDeleteAttachmentUpload:function e(t){var r=this;var a=this.getView().getBindingContext();var n=a.getProperty("DefectInternalID");var o=t.getParameter("item");var i=o.getBindingContext("__attachmentData").getObject();var c=this.oAttachmentODataModel.createKey("/OriginalContentSet",{FileId:i.FileId,ApplicationId:i.ApplicationId,Filename:i.Filename,Documentnumber:i.Documentnumber,Documenttype:i.Documenttype,Documentpart:i.Documentpart,Documentversion:i.Documentversion});this.oAttachmentODataModel.remove(c,{headers:{objectkey:btoa(encodeURIComponent(n)),objecttype:"QFGEN",semanticobjecttype:"",markfordeletion:"true"},success:function e(){var t=r.oAttachmentModel.getData(),a=t.items;var n=a.filter(function(e){return e!==i});r.oAttachmentModel.setData({items:n})},error:function e(t){var a=r.parseError(t);s.error(a,{title:r.translate("defect_attachment_delete_error")})}})},onTakePictureAsAttachment:function t(){var a=this;var n=undefined;var c=undefined;var u="video-player-".concat((new Date).getTime());var l=new r({busy:true,title:this.translate("take_picture_dialog_title"),beginButton:new e({text:this.translate("common_action_capture"),type:R.Emphasized,press:function e(){l.setBusy(true);n.pause();var t=document.createElement("canvas");var r=t.getContext("2d");t.width=n.videoWidth;t.height=n.videoHeight;r.drawImage(n,0,0);var o="image/jpeg";t.toBlob(function(e){a._uploadFile(new File([e],"image.jpg",{type:o}));l.close()},o)}}),content:[new i({alignItems:U.Center,fitContainer:true,items:[new o({content:"<video id='".concat(u,"' autoplay/>")})]})],afterOpen:function e(){n=document.getElementById(u);navigator.mediaDevices.getUserMedia({audio:false,video:{facingMode:"environment"}}).then(function(e){if(!l.isOpen()){e.getTracks().forEach(function(e){return e.stop()});return}l.setBusy(false);c=e;if(n){n.srcObject=e}})["catch"](function(e){l.setBusy(false);l.close();var t=a.parseError(e);s.error(t,{title:a.translate("common_text_error")})})},afterClose:function e(){l.close();if(c){c.getTracks().forEach(function(e){return e.stop()});c=undefined;n=undefined}if(n){n.pause();n.src="";n.srcObject=null;n=undefined}},endButton:new e({text:this.translate("common_action_cancel"),press:function e(){l.close()}})});l.open()},_uploadFile:function e(t){var r=this.getView().byId("attachmentServiceFileUpload");var a=new DataTransfer;a.items.add(t);var n=r._oFileUploader;var o=n.oFileUpload;o.files=a.files;o.dispatchEvent(new window.Event("change"))},_readAttachments:function e(){try{var t=this;var r=t.getView().getBindingContext();var a=r.getProperty("DefectInternalID");var n=r.getProperty("IsActiveEntity");return x(I(new Promise(function(e,r){t.oAttachmentODataModel.callFunction("/GetAllOriginals",{method:"GET",urlParameters:{ObjectType:"QFGEN",ObjectKey:a,SemanticObjectType:"",IsDraft:JSON.stringify(!n),AttachmentFramework:""},success:function r(a){var n=a.results.map(function(e){return t._mapOriginalContentToAttachmentItem(e)});t.oAttachmentModel.setData({items:n});t.oAttachmentModel.refresh(true);e()},error:r})})))}catch(e){return Promise.reject(e)}},_mapOriginalContentToAttachmentItem:function e(t){var r=t.CreatedAt==null?null:t.CreatedAt instanceof Date?t.CreatedAt:new Date(parseInt(t.CreatedAt.substr(6)));var a=typeof t.ContentType==="string"?t.ContentType.toLowerCase().indexOf("image/")===0:false;return{FileId:t.FileId,ApplicationId:t.ApplicationId,Filename:t.Filename,Documentnumber:t.Documentnumber?t.Documentnumber:"",Documenttype:t.Documenttype,Documentversion:t.Documentversion?t.Documentversion:"",Documentpart:t.Documentpart?t.Documentpart:"",thumbnailUrl:a&&t.__metadata.media_src?this._removeHostFromSapUrl(t.__metadata.media_src):null,createdAt:r!=null?r.getTime():null,attributes:[{title:this.oAttachmentODataModel.getProperty("/#OriginalContent/CreatedAt/@sap:label"),text:this._formatDate(r),visible:true},{title:this.oAttachmentODataModel.getProperty("/#OriginalContent/Filesize/@sap:label"),text:this._formatFileSize(t.Filesize),visible:true}],markers:t.AttachmentStatus!=="DRAFT"?[]:[{type:"Draft"}]}},_removeHostFromSapUrl:function e(t){return t.substring(t.indexOf("/sap/opu/odata/"),t.length)},_formatDate:function e(t){return f.getDateTimeInstance({style:"medium"}).format(t)},_formatFileSize:function e(t){return g.getInstance({binaryFilesize:false,maxFractionDigits:2,maxIntegerDigits:3}).format(t)},initDefectCategory:function e(t,r){try{var a=this;if(a.defectCategory===t&&a.layoutVariant===r){return x()}a.defectCategory=t;a.layoutVariant=r;var n="zqm.nc.recdefectfast.fragment.form.".concat(a.defectCategory,"-").concat(a.layoutVariant,"-Form");return x(m.load({id:a.getView().getId(),controller:a,name:n}),function(e){var t=e;var r=a.getView().byId("form-fragment-content");r.removeAllContent();r.addContent(t)})}catch(e){return Promise.reject(e)}},showMessageBox:function e(t){try{var r=t.type==="confirm"?s.confirm:t.type==="warning"?s.warning:s.confirm;return x(new Promise(function(e){r(t.message,{title:t.title,actions:[L.OK,L.CANCEL],emphasizedAction:L.OK,onClose:function t(r){e(r===L.OK)}})}))}catch(e){return Promise.reject(e)}},requestUserConfirmation:function e(){try{var t=this;var r=t.getView().getBindingContext();var a=r.getProperty("DefectCategory");var n=r.getProperty("ZZ1_NC_LAYOUT_VARIANT_NIT");var o=r.getProperty("Material");if(a==="ZL"&&n==="STANDARD"&&!o){return x(t.showMessageBox({type:"confirm",message:t.translate("defect_confirm_missing_material")}))}return x(true)}catch(e){return Promise.reject(e)}},getTemplateProperties:function e(){var t=this.getView().getControlsByFieldGroupId(J.TEMPLATE).filter(function(e){return["sap.m.Input","sap.m.ComboBox","sap.m.Switch","sap.ui.comp.smartfield.SmartField"].indexOf(e.getMetadata().getName())!==-1}).map(function(e){switch(e.getMetadata().getName()){case"sap.m.ComboBox":case"sap.m.Input":case"sap.ui.comp.smartfield.SmartField":{return e.getBinding("value").getPath()}case"sap.m.Switch":return e.getBinding("state").getPath();default:{return}}}).filter(function(e){return e!=null});return M(t)},getTemplateValues:function e(){var t=this;var r=this.getTemplateProperties();var a=q(this.oODataModel.getMetaModel(),"C_DefectRecord",r);return a.filter(function(e){return e!=null}).map(function(e){return{property:e,value:t.getView().getBindingContext().getProperty(e)}}).reduce(function(e,t){return j(j({},e),{},N({},t.property,t.value))},{})},getMessagePopover:function e(){var t=this;if(this.messagePopover==null){this.messagePopover=m.load({id:this.getView().getId(),name:"zqm.nc.recdefectfast.fragment.MessagePopover"}).then(function(e){t.getView().addDependent(e);return e})}return this.messagePopover}});return $});