{"version":3,"sources":["../../src/util/ValueHelp.ts"],"names":["value","then","direct","Promise","resolve","getEntitySetNameByBindingContextPath","getODataEntityTypeByEntitySet","getODataPropertyForEntitySet","ODataValueListParameterRecordType","ValueHelp","oBindingContext","sPropertyName","oModel","getModel","getMetadata","getName","metadataLoaded","oMetaModel","getMetaModel","loaded","sModelEntitySet","getPath","oEntityTypeDefinition","oValueHelpDefinition","oValueHelpDefinitionEntityType","CollectionPath","String","aValueHelpDefinitionEntityTypeKeys","key","propertyRef","map","k","name","aKeyParameters","Parameters","filter","p","ValueListProperty","indexOf","oOriginalKey","find","LocalDataProperty","PropertyPath","aOtherKeys","oValueHelpDialog","ValueHelpDialog","title","keys","supportMultiselect","supportRanges","supportRangesOnly","ok","oControlEvent","oTable","getTable","iSelectedIndex","getSelectedIndices","shift","oSelectedItemBindingContext","getContextByIndex","RecordType","ValueListParameterInOut","ValueListParameterOut","forEach","sValue","getProperty","sAbsolutePath","console","log","setProperty","firePropertyChange","reason","ChangeReason","Change","path","context","close","cancel","afterClose","destroy","cols","ValueListParameterDisplayOnly","label","property","oPropDefinition","type","col","Column","Label","text","template","CheckBox","selected","enabled","Text","column","addColumn","aFilters","ValueListParameterIn","Filter","FilterOperator","EQ","f","setModel","bindRows","filters","open"],"mappings":"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","sourcesContent":["import CheckBox from \"sap/m/CheckBox\";\nimport Label from \"sap/m/Label\";\nimport Text from \"sap/m/Text\";\nimport Event from \"sap/ui/base/Event\";\nimport ValueHelpDialog from \"sap/ui/comp/valuehelpdialog/ValueHelpDialog\";\nimport ChangeReason from \"sap/ui/model/ChangeReason\";\nimport Context from \"sap/ui/model/Context\";\nimport Filter from \"sap/ui/model/Filter\";\nimport FilterOperator from \"sap/ui/model/FilterOperator\";\nimport ODataMetaModel from \"sap/ui/model/odata/ODataMetaModel\";\nimport ODataModel from \"sap/ui/model/odata/v2/ODataModel\";\nimport Column from \"sap/ui/table/Column\";\nimport Table from \"sap/ui/table/Table\";\nimport {\n    getEntitySetNameByBindingContextPath,\n    getODataEntityTypeByEntitySet,\n    getODataPropertyForEntitySet,\n    ODataValueListParameterIn,\n    ODataValueListParameterInOut,\n    ODataValueListParameterOut,\n    ODataValueListParameterRecordType\n} from \"zqm/nc/recdefectfast/util/ODataHelper\";\n\n/**\n * @namespace zqm.nc.recdefectfast.util\n */\nexport default class ValueHelp {\n\n\n    static async showValueHelp(oBindingContext: Context, sPropertyName: string) {\n        const oModel: ODataModel = oBindingContext.getModel() as ODataModel;\n\n        if (oModel.getMetadata().getName() !== \"sap.ui.model.odata.v2.ODataModel\") {\n            // todo log unsupported\n            return;\n        }\n\n        // ensure odata model & metadata are completely loaded\n        await oModel.metadataLoaded(true);\n        const oMetaModel: ODataMetaModel = oModel.getMetaModel();\n        await oMetaModel.loaded();\n\n        const sModelEntitySet = getEntitySetNameByBindingContextPath(oBindingContext.getPath());\n        const oEntityTypeDefinition = getODataPropertyForEntitySet(oMetaModel, sModelEntitySet, sPropertyName);\n        const oValueHelpDefinition = oEntityTypeDefinition[\"com.sap.vocabularies.Common.v1.ValueList\"];\n        if (oValueHelpDefinition == null) {\n            return;\n        }\n\n        const oValueHelpDefinitionEntityType = getODataEntityTypeByEntitySet(oMetaModel, oValueHelpDefinition.CollectionPath.String);\n        if (oValueHelpDefinitionEntityType == null) {\n            return;\n        }\n\n        const aValueHelpDefinitionEntityTypeKeys = oValueHelpDefinitionEntityType.key.propertyRef.map((k) => k.name);\n        const aKeyParameters = oValueHelpDefinition.Parameters\n            .filter((p) => p.ValueListProperty.String != null && aValueHelpDefinitionEntityTypeKeys.indexOf(p.ValueListProperty.String) !== -1);\n\n        const oOriginalKey = aKeyParameters.find((p) => (p as ODataValueListParameterInOut).LocalDataProperty != null && (p as ODataValueListParameterInOut).LocalDataProperty.PropertyPath === sPropertyName);\n        const aOtherKeys = aKeyParameters.filter(p => p !== oOriginalKey);\n\n        // init value help\n        const oValueHelpDialog = new ValueHelpDialog({\n            title: oEntityTypeDefinition[\"sap:label\"],\n            key: oOriginalKey?.ValueListProperty.String,\n            keys: aOtherKeys.map((p) => p.ValueListProperty.String),\n            // keys: aValueHelpDefinitionEntityTypeKeys,\n            supportMultiselect: false,\n            supportRanges: false,\n            supportRangesOnly: false,\n            ok: (oControlEvent: Event) => {\n                // Note: tokens doesn't work, cause they contain only a single value, but we need the fully identified object\n               // TODO async table\n                const oTable: Table = oValueHelpDialog.getTable() as Table;\n                const iSelectedIndex = oTable.getSelectedIndices().shift();\n                if (iSelectedIndex != null) {\n                    const oSelectedItemBindingContext = oTable.getContextByIndex(iSelectedIndex);\n                    // sync selected item back to original odata model\n                    oValueHelpDefinition.Parameters\n                        .filter((p): p is ODataValueListParameterInOut | ODataValueListParameterOut => p.RecordType === ODataValueListParameterRecordType.ValueListParameterInOut || p.RecordType === ODataValueListParameterRecordType.ValueListParameterOut)\n                        .forEach((p) => {\n                            const sValue = oSelectedItemBindingContext.getProperty(p.ValueListProperty.String) as string;\n                            const sAbsolutePath = oBindingContext.getPath(p.LocalDataProperty.PropertyPath);\n\n                            console.log(\"setting\", sAbsolutePath, \"to\", sValue);\n                            oModel.setProperty(sAbsolutePath, sValue);\n\n                            oModel.firePropertyChange({\n                                reason: ChangeReason.Change,\n                                path: p.LocalDataProperty.PropertyPath,\n                                value: sValue as unknown as object, // provided types are wrong\n                                context: oBindingContext\n                            })\n                        });\n                }\n\n                oValueHelpDialog.close();\n            },\n            cancel: () => {\n                oValueHelpDialog.close();\n            },\n            afterClose: () => {\n                oValueHelpDialog.destroy();\n            }\n        });\n\n        const cols = oValueHelpDefinition.Parameters\n            .filter((p) =>\n                p.RecordType === ODataValueListParameterRecordType.ValueListParameterInOut ||\n                p.RecordType === ODataValueListParameterRecordType.ValueListParameterDisplayOnly ||\n                p.RecordType === ODataValueListParameterRecordType.ValueListParameterOut\n            )\n            .map((p) => ({\n                label: oValueHelpDefinitionEntityType.property.find((oPropDefinition) => oPropDefinition.name === p.ValueListProperty.String)?.[\"sap:label\"],\n                type: oValueHelpDefinitionEntityType.property.find((oPropDefinition) => oPropDefinition.name === p.ValueListProperty.String)?.type,\n                property: p.ValueListProperty.String\n            }))\n            .filter((col) => col.label != null)\n            .map((p) => new Column({\n                label: new Label({text: p.label}),\n                template: p.type === \"Edm.Boolean\" ? new CheckBox({selected: {path: p.property}, enabled: false },) :  new Text({text: {path: p.property }})\n            }));\n\n\n        // todo async table\n        const oTable: Table = oValueHelpDialog.getTable() as Table;\n\n        cols.forEach((column) => {\n            oTable.addColumn(column);\n        });\n\n        const aFilters: Array<Filter> = oValueHelpDefinition.Parameters\n            .filter((p): p is ODataValueListParameterInOut | ODataValueListParameterIn =>\n                p.RecordType === ODataValueListParameterRecordType.ValueListParameterInOut ||\n                p.RecordType === ODataValueListParameterRecordType.ValueListParameterIn\n            )\n            .filter((p) => p.LocalDataProperty.PropertyPath != null && p.LocalDataProperty.PropertyPath !== sPropertyName)\n            .map((p) => {\n                const sValue = oBindingContext.getProperty(p.LocalDataProperty.PropertyPath) as string;\n\n                if (sValue != null && sValue !== \"\") {\n                    return new Filter(p.ValueListProperty.String, FilterOperator.EQ, sValue);\n                }\n                return null;\n            })\n            .filter((f): f is Filter => f != null);\n\n        oTable.setModel(oModel);\n        oTable.bindRows({\n            path: \"/\" + oValueHelpDefinition.CollectionPath.String,\n            filters: aFilters\n        });\n\n\n        oValueHelpDialog.open();\n        // oValueHelpDialog.update();\n\n\n    }\n\n\n}"],"file":"ValueHelp.js"}